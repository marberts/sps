<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Drawing a Sequential Poisson Sample • sps</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="../deps/MathJax-3.2.2/tex-chtml.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Drawing a Sequential Poisson Sample">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">sps</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.0.9002</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/sps.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/take-all.html">Take-all units</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/marberts/sps/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Drawing a Sequential Poisson Sample</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/marberts/sps/blob/main/vignettes/sps.Rmd" class="external-link"><code>vignettes/sps.Rmd</code></a></small>
      <div class="d-none name"><code>sps.Rmd</code></div>
    </div>

    
    
<p>Sequential Poisson sampling is a variation of Poisson sampling for
drawing probability-proportional-to-size samples with a given number of
units. It’s a fast, simple, and flexible method for sampling units
proportional to their size, and is often used for drawing a sample of
businesses. The purpose of this vignette is to give an example of how
the functions in this package can be used to easily draw a sample using
the sequential Poisson method. More details can be found on the help
pages for the functions used in this vignette.</p>
<div class="section level2">
<h2 id="drawing-a-sample-of-businesses">Drawing a sample of businesses<a class="anchor" aria-label="anchor" href="#drawing-a-sample-of-businesses"></a>
</h2>
<p>Consider the problem of drawing a sample of businesses in order to
measure the value of sales for the current quarter. The frame is a
business register that gives an enumeration of all businesses in
operation, along with the revenue of each business from the previous
year and the region in which they are headquartered.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://marberts.github.io/sps/">sps</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123654</span><span class="op">)</span></span>
<span></span>
<span><span class="va">frame</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  revenue <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span><span class="fl">1e3</span><span class="op">)</span> <span class="op">*</span> <span class="fl">1000</span><span class="op">)</span>,</span>
<span>  region <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1e3</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.5</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">frame</span><span class="op">)</span></span>
<span><span class="co">#&gt;   revenue region</span></span>
<span><span class="co">#&gt; 1    2676      1</span></span>
<span><span class="co">#&gt; 2    2158      1</span></span>
<span><span class="co">#&gt; 3    2046      3</span></span>
<span><span class="co">#&gt; 4     537      2</span></span>
<span><span class="co">#&gt; 5     266      3</span></span>
<span><span class="co">#&gt; 6    1991      1</span></span></code></pre></div>
<p>Associated with each business is a value for their sales for the
current quarter, although these values are not observable for all
businesses. The purpose of drawing a sample is to observe sales for a
subset of businesses, and extrapolate the value of sales from the sample
of business to the entire population. Sales are positively correlated
with last year’s revenue, and this is the basis for sampling businesses
proportional to revenue.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sales</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">frame</span><span class="op">$</span><span class="va">revenue</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1e3</span>, <span class="fl">0.5</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Budget constraints mean that it’s feasible to draw a sample of 100
businesses. Businesses operate in different regions, and so the sample
will be stratified by region. This requires determining how the total
sample size of 100 is allocated across regions. A common approach is to
do this allocation proportional to the total revenue in each region.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">allocation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">frame</span>, <span class="fu"><a href="../reference/prop_allocation.html">prop_allocation</a></span><span class="op">(</span><span class="va">revenue</span>, <span class="fl">100</span>, <span class="va">region</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">allocation</span></span>
<span><span class="co">#&gt;  1  2  3 </span></span>
<span><span class="co">#&gt; 19 32 49</span></span></code></pre></div>
<p>With the sample size for each region in hand, it’s now time to draw a
sample and observe the value of sales for these businesses. In practice
this is usually the result of a survey that’s administered to the
sampled units.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">frame</span>, <span class="fu"><a href="../reference/sps.html">sps</a></span><span class="op">(</span><span class="va">revenue</span>, <span class="va">allocation</span>, <span class="va">region</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">survey</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">frame</span><span class="op">[</span><span class="va">sample</span>, <span class="op">]</span>, sales <span class="op">=</span> <span class="va">sales</span><span class="op">[</span><span class="va">sample</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">survey</span><span class="op">)</span></span>
<span><span class="co">#&gt;    revenue region sales</span></span>
<span><span class="co">#&gt; 8     1422      3  1571</span></span>
<span><span class="co">#&gt; 25    2741      2  1843</span></span>
<span><span class="co">#&gt; 31     580      1   897</span></span>
<span><span class="co">#&gt; 37    4508      2  8659</span></span>
<span><span class="co">#&gt; 38    1007      3  1804</span></span>
<span><span class="co">#&gt; 42    2380      3  4740</span></span></code></pre></div>
<p>An important piece of information from the sampling process is the
design weights, as these enable estimating the value of sales in the
population with the usual Horvitz-Thompson estimator.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">survey</span><span class="op">$</span><span class="va">weight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/weights.html" class="external-link">weights</a></span><span class="op">(</span><span class="va">sample</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">survey</span><span class="op">)</span></span>
<span><span class="co">#&gt;    revenue region sales    weight</span></span>
<span><span class="co">#&gt; 8     1422      3  1571 11.254659</span></span>
<span><span class="co">#&gt; 25    2741      2  1843  6.070412</span></span>
<span><span class="co">#&gt; 31     580      1   897 27.752969</span></span>
<span><span class="co">#&gt; 37    4508      2  8659  3.690994</span></span>
<span><span class="co">#&gt; 38    1007      3  1804 15.892875</span></span>
<span><span class="co">#&gt; 42    2380      3  4740  6.724422</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ht</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">survey</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">sales</span> <span class="op">*</span> <span class="va">weight</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ht</span></span>
<span><span class="co">#&gt; [1] 2039582</span></span></code></pre></div>
<p>The Horvitz-Thompson estimator is (asymptotically) unbiased under
sequential Poisson sampling, so it should be no surprise that the
estimate is fairly close the true (but unknown) value of sales among all
businesses.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ht</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">sales</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="co">#&gt; [1] 0.01325931</span></span></code></pre></div>
<p>But in practice it’s not possible to determine how far an estimate is
from the true value in the population. Instead, a common measure of the
quality of a estimate is the coefficient of variation, and this requires
estimating the variance of the Horvitz-Thompson estimator.</p>
<p>A general approach for estimating the variance of the
Horvitz-Thompson estimator is to construct bootstrap replicate weights
from the design weights for the sample, compute a collection of
estimates for the total based on these replicate weights, and then
compute the variance of this collection of estimates.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">repweights</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sps_repweights.html">sps_repweights</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/weights.html" class="external-link">weights</a></span><span class="op">(</span><span class="va">sample</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">repweights</span>, <span class="st">"tau"</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">*</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">survey</span><span class="op">$</span><span class="va">sales</span> <span class="op">*</span> <span class="va">repweights</span><span class="op">)</span> <span class="op">-</span> <span class="va">ht</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span> <span class="op">/</span> <span class="va">ht</span></span>
<span><span class="co">#&gt; [1] 0.09666341</span></span></code></pre></div>
<p>There is also an analytic estimator for the variance of the
Horvitz-Thompson estimator under sequential Poisson sampling. It’s less
flexible than the bootstrap estimator, but is more precise.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_var</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span>, <span class="va">w</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">w</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">w</span> <span class="op">&lt;-</span> <span class="va">w</span><span class="op">[</span><span class="va">w</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span>  <span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">y</span> <span class="op">*</span> <span class="va">w</span><span class="op">)</span></span>
<span>  <span class="va">n</span> <span class="op">/</span> <span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">w</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">w</span> <span class="op">*</span> <span class="va">y</span> <span class="op">-</span> <span class="va">Y</span> <span class="op">/</span> <span class="va">n</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span></span>
<span>  <span class="va">survey</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/mapply.html" class="external-link">mapply</a></span><span class="op">(</span><span class="va">sps_var</span>, <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">sales</span>, <span class="va">region</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">weight</span>, <span class="va">region</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="va">ht</span></span>
<span><span class="co">#&gt; [1] 0.03067625</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="coordinating-samples">Coordinating samples<a class="anchor" aria-label="anchor" href="#coordinating-samples"></a>
</h2>
<p>Suppose another sample of businesses from the same frame is needed
for a purpose other than measuring the value of sales. It is often
desirable to negatively coordinate these samples so that the same
businesses are not inundated with responding to surveys, without
affecting the statistical properties of the sample. This sort of
coordination is easily done by associating to each business a permanent
random number, and suitably “rotating” them to reduce the overlap
between both samples.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">frame</span><span class="op">$</span><span class="va">prn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">frame</span><span class="op">)</span></span>
<span><span class="co">#&gt;   revenue region        prn</span></span>
<span><span class="co">#&gt; 1    2676      1 0.72614569</span></span>
<span><span class="co">#&gt; 2    2158      1 0.30042829</span></span>
<span><span class="co">#&gt; 3    2046      3 0.09393538</span></span>
<span><span class="co">#&gt; 4     537      2 0.31786097</span></span>
<span><span class="co">#&gt; 5     266      3 0.23796557</span></span>
<span><span class="co">#&gt; 6    1991      1 0.80298366</span></span></code></pre></div>
<p>Permanent random numbers can be used with methods other than
sequential Poisson—the procedure is the same for any order sampling
scheme (including simple random sampling).</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pareto</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sps.html">order_sampling</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">frame</span>, <span class="fu"><a href="../reference/sps.html">sps</a></span><span class="op">(</span><span class="va">revenue</span>, <span class="va">allocation</span>, <span class="va">region</span>, <span class="va">prn</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">parsample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">frame</span>, <span class="fu">pareto</span><span class="op">(</span><span class="va">revenue</span>, <span class="va">allocation</span>, <span class="va">region</span>, <span class="op">(</span><span class="va">prn</span> <span class="op">-</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">sample</span>, <span class="va">parsample</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fl">100</span></span>
<span><span class="co">#&gt; [1] 0.09</span></span></code></pre></div>
<p>Although there is still a meaningful overlap between the units in
both samples, this is roughly half of what would be expected without
using permanent random numbers.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="op">{</span></span>
<span>  <span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">frame</span>, <span class="fu">pareto</span><span class="op">(</span><span class="va">revenue</span>, <span class="va">allocation</span>, <span class="va">region</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">sample</span>, <span class="va">s</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fl">100</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;  0.1200  0.2000  0.2300  0.2275  0.2500  0.3500</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="topping-up">Topping up<a class="anchor" aria-label="anchor" href="#topping-up"></a>
</h2>
<p>The sequential part of sequential Poisson sampling means that it’s
easy to grow a sample. Suppose that there is a need to sample 10 more
businesses in region 1 after the sample is drawn. Simply adding 10 units
to the allocation for region 1 results in a new sample that includes all
the previously sampled units, so the extra units can be surveyed without
discarding previously-collected data or affecting the statistical
properties of the sample.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">frame</span>, <span class="fu"><a href="../reference/sps.html">sps</a></span><span class="op">(</span><span class="va">revenue</span>, <span class="va">allocation</span>, <span class="va">region</span>, <span class="va">prn</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sample_tu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">frame</span>, <span class="fu"><a href="../reference/sps.html">sps</a></span><span class="op">(</span><span class="va">revenue</span>, <span class="va">allocation</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="va">region</span>, <span class="va">prn</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">sample</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">sample_tu</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>As with any proportional-to-size sampling scheme, there is a critical
sample size after which some units become take-all units. If these units
are not already in the sample then they can “bump” previously sampled
units, requiring a larger sample size to keep all the previously sampled
units in the new sample. This can be seen by finding the sample size at
which each unit enters the take-all stratum.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Map</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/inclusion_prob.html">becomes_ta</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">frame</span><span class="op">$</span><span class="va">revenue</span>, <span class="va">frame</span><span class="op">$</span><span class="va">region</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; $`1`</span></span>
<span><span class="co">#&gt; [1]  86  98 102 174 161 160</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`2`</span></span>
<span><span class="co">#&gt; [1] 278 157 261 254 110 284</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`3`</span></span>
<span><span class="co">#&gt; [1] 283 500 500 344 449 482</span></span></code></pre></div>
<p>But this is rare in practice. For this example there is no point at
which increasing the sample size drops a unit that was previously
included in the sample. Seeing this in action requires different
data.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">13026</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/inclusion_prob.html">becomes_ta</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 10  4  5  5  5  9  8 10  9  9</span></span>
<span></span>
<span><span class="va">sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sps.html">sps</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">4</span>, prn <span class="op">=</span> <span class="va">u</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sample</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="../reference/sps.html">sps</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">5</span>, prn <span class="op">=</span> <span class="va">u</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  TRUE  TRUE  TRUE FALSE</span></span></code></pre></div>
<p>The solution to this problem is to simply increase the size of the
sample until all previously sampled units are included.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sample</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="../reference/sps.html">sps</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">6</span>, prn <span class="op">=</span> <span class="va">u</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE TRUE TRUE TRUE</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="bias-in-the-horvitz-thompson-estimator">Bias in the Horvitz-Thompson estimator<a class="anchor" aria-label="anchor" href="#bias-in-the-horvitz-thompson-estimator"></a>
</h2>
<p>Despite it’s simplicity, sequential Poisson sampling is only
asymptotically proportional to size. This means that the
Horvitz-Thompson estimator can be biased in small samples, although this
bias is usually negligible for real-world sample sizes.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sampling_distribution</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="op">{</span></span>
<span>  <span class="va">sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">frame</span>, <span class="fu"><a href="../reference/sps.html">sps</a></span><span class="op">(</span><span class="va">revenue</span>, <span class="va">allocation</span>, <span class="va">region</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">sales</span><span class="op">[</span><span class="va">sample</span><span class="op">]</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/weights.html" class="external-link">weights</a></span><span class="op">(</span><span class="va">sample</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">sampling_distribution</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">sales</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt;       Min.    1st Qu.     Median       Mean    3rd Qu.       Max. </span></span>
<span><span class="co">#&gt; -0.1043517 -0.0208040  0.0016497  0.0005927  0.0215847  0.1426320</span></span></code></pre></div>
<p>More generally, the distribution of inclusion probabilities is
usually close to what is expected if sequential Poisson sampling was
exactly proportional to size.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;See Tillé, Y. (2023). Remarks on some misconceptions
about unequal probability sampling without replacement. &lt;em&gt;Computer
Science Review&lt;/em&gt;, 47, 100533.&lt;/p&gt;"><sup>1</sup></a></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123456</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">5e3</span></span>
<span><span class="va">frame1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">frame</span>, <span class="va">region</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pi_est</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tabulate.html" class="external-link">tabulate</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="va">n</span>, <span class="fu"><a href="../reference/sps.html">sps</a></span><span class="op">(</span><span class="va">frame1</span><span class="op">$</span><span class="va">revenue</span>, <span class="va">allocation</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  nbins <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">frame1</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">/</span> <span class="va">n</span></span>
<span></span>
<span><span class="va">pi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/inclusion_prob.html">inclusion_prob</a></span><span class="op">(</span><span class="va">frame1</span><span class="op">$</span><span class="va">revenue</span>, <span class="va">allocation</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dist</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">pi_est</span> <span class="op">-</span> <span class="va">pi</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">pi</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">pi</span><span class="op">)</span> <span class="op">/</span> <span class="va">n</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/density.html" class="external-link">density</a></span><span class="op">(</span><span class="va">dist</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  ylab <span class="op">=</span> <span class="st">""</span>, xlab <span class="op">=</span> <span class="st">""</span>,</span>
<span>  main <span class="op">=</span> <span class="st">"Empirical distribution of inclusion probabilities"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">0.1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span>, lty <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"empirical"</span>, <span class="st">"theoretical"</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"solid"</span>, <span class="st">"dashed"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="sps_files/figure-html/tille-1.png" alt="Empirical distribution of inclusion probabilities under sequential Poisson sampling is approximately Guassian." width="768"></p>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Steve Martin.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
